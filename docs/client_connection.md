# OpenP2P 客户端连接说明

## 连接流程

OpenP2P客户端连接服务器的流程如下：

1. **读取配置文件**：客户端首先读取配置文件，获取服务器地址、端口、节点令牌等信息。
2. **验证配置**：客户端向服务器发送验证请求，检查配置是否有效。
3. **建立连接**：验证通过后，客户端向服务器发送连接请求，建立长连接。
4. **心跳维持**：连接建立后，客户端每30秒向服务器发送一次心跳包，维持连接。
5. **断线重连**：如果连接断开，客户端会自动尝试重新连接。

## 连接问题排查

### 1. 无法连接到服务器

如果客户端无法连接到服务器，可能有以下原因：

#### 配置问题

- **服务器地址格式错误**：确保服务器地址不包含`http://`或`https://`前缀。
  - 正确：`openp2p.example.com`
  - 错误：`http://openp2p.example.com`

- **端口配置错误**：确认服务器端口是否正确，默认为27183。

- **节点令牌无效**：检查节点令牌是否正确，可以在管理界面重新创建节点获取新的令牌。

#### 网络问题

- **防火墙阻止**：检查防火墙是否阻止了客户端的连接请求。
  - Windows: 检查Windows防火墙设置
  - Linux: 检查iptables规则
  - macOS: 检查系统偏好设置中的安全性与隐私

- **网络连接不稳定**：检查网络连接是否稳定，可以使用ping命令测试：
  ```
  ping openp2p.example.com
  ```

- **DNS解析问题**：如果使用域名，检查DNS解析是否正常，可以尝试使用IP地址替代域名。

#### 服务器问题

- **服务器未运行**：确认服务器是否正常运行。

- **服务器负载过高**：服务器可能因负载过高而无法响应请求。

### 2. 连接断开问题

如果客户端连接经常断开，可能有以下原因：

- **网络不稳定**：检查网络连接是否稳定。

- **心跳包丢失**：如果网络延迟较高，心跳包可能无法及时到达服务器，导致服务器认为客户端已断开。

- **服务器重启**：服务器可能进行了重启或维护。

- **客户端被挤下线**：同一节点令牌被其他客户端使用，导致当前客户端被挤下线。

### 3. 日志分析

查看客户端日志可以帮助定位连接问题。日志文件位于：

- Windows: `%LOCALAPPDATA%\OpenP2P\logs\`
- Linux: `~/.local/share/openp2p/logs/`
- macOS: `~/Library/Application Support/OpenP2P/logs/`

或当前目录下的`logs`文件夹。

常见错误日志及解决方法：

- **"读取配置文件失败"**：检查配置文件路径是否正确，文件是否存在。

- **"解析配置文件失败"**：检查配置文件格式是否正确，是否为有效的JSON格式。

- **"服务器地址不能为空"**：在配置文件中填写正确的服务器地址。

- **"节点令牌不能为空"**：在配置文件中填写正确的节点令牌。

- **"发送验证请求失败"**：检查网络连接和服务器地址是否正确。

- **"验证失败"**：检查节点令牌是否正确，节点是否已在管理界面创建。

- **"发送连接请求失败"**：检查网络连接和服务器地址是否正确。

- **"连接失败"**：检查节点令牌是否正确，节点是否已在管理界面创建。

- **"心跳失败"**：检查网络连接是否稳定，服务器是否正常运行。

## 高级连接设置

### 使用固定P2P端口

如果需要使用固定的P2P端口（例如需要在防火墙上开放特定端口），可以在配置文件中设置`p2p_port`字段：

```json
{
  "p2p_port": 12345
}
```

### 绑定特定网络接口

如果需要绑定特定的网络接口（例如有多个网卡），可以在配置文件中设置`bind`字段：

```json
{
  "bind": "192.168.1.100"
}
```

### 增加日志级别

如果需要更详细的日志以便排查问题，可以增加日志级别：

```json
{
  "log_level": 3
}
```

## 常见问题解答

### Q: 客户端显示"连接服务器失败"怎么办？

A: 检查以下几点：
1. 确认服务器地址和端口是否正确
2. 确认节点令牌是否正确
3. 检查网络连接是否正常
4. 检查服务器是否正常运行

### Q: 客户端连接成功后很快断开怎么办？

A: 可能是心跳包问题或网络不稳定，尝试以下方法：
1. 检查网络连接是否稳定
2. 确认服务器是否正常运行
3. 检查是否有其他客户端使用了相同的节点令牌

### Q: 如何确认客户端是否成功连接？

A: 客户端日志中会显示"连接成功"的信息，同时在管理界面的节点列表中可以看到节点状态为"在线"。

### Q: 配置文件中的username和password字段是否必须？

A: 不是必须的。这些字段是为了兼容旧版本，在新版本中不再使用。客户端只需要正确的节点令牌（token）即可连接服务器。

## 客户端配置说明

OpenP2P客户端使用JSON格式的配置文件，默认为`config.json`。以下是配置文件的详细说明：

```json
{
  "server": "openp2p.example.com",  // 服务器地址，不要包含http://前缀
  "port": 27183,                    // 服务器端口，默认27183
  "name": "Office",                 // 节点名称，用于在管理界面中显示
  "token": "your_token_here",       // 节点令牌，从管理界面创建节点时获取
  "bind": "0.0.0.0",                // 绑定地址，默认0.0.0.0
  "p2p_port": 0,                    // P2P端口，0表示随机选择
  "log_level": 2,                   // 日志级别：0=关闭，1=错误，2=信息，3=调试
  "auto_start": false,              // 是否自动启动
  "auto_login": false,              // 是否自动登录
  "language": "zh_CN",              // 界面语言
  "theme": "light"                  // 界面主题
}
```

## 客户端日志

客户端日志默认保存在以下位置：

- Windows: `%LOCALAPPDATA%\OpenP2P\logs\`
- Linux: `~/.local/share/openp2p/logs/`
- macOS: `~/Library/Application Support/OpenP2P/logs/`

如果找不到日志文件，请检查：

1. 客户端是否有写入权限
2. 日志级别设置（config.json中的log_level）
3. 是否有其他路径覆盖设置

## 故障排除步骤

1. **检查客户端日志**：查看客户端日志文件，寻找错误信息
2. **验证配置文件**：确保配置文件格式正确，所有必要字段都已填写
3. **测试网络连接**：使用ping或telnet测试客户端是否可以连接到服务器
4. **重启客户端**：有时候简单地重启客户端可以解决连接问题
5. **更新客户端**：确保使用的是最新版本的客户端

如果以上步骤无法解决问题，请联系系统管理员获取帮助。

## 客户端API说明

客户端与服务器通信使用以下API：

### 1. 验证配置

```