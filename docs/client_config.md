# OpenP2P 客户端配置说明

## 配置文件格式

OpenP2P客户端使用JSON格式的配置文件，默认文件名为`config.json`。配置文件应放置在客户端可执行文件所在的目录中，或通过`-config`参数指定路径。

## 配置项说明

| 配置项 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| server | 字符串 | 是 | 无 | 服务器地址，不要包含http://前缀 |
| port | 整数 | 否 | 27183 | 服务器端口 |
| name | 字符串 | 否 | 系统主机名 | 节点名称，用于在管理界面中显示 |
| token | 字符串 | 是 | 无 | 节点令牌，从管理界面创建节点时获取 |
| bind | 字符串 | 否 | 0.0.0.0 | 绑定地址 |
| p2p_port | 整数 | 否 | 0 | P2P端口，0表示随机选择 |
| log_level | 整数 | 否 | 2 | 日志级别：0=关闭，1=错误，2=信息，3=调试 |
| auto_start | 布尔值 | 否 | false | 是否自动启动 |
| auto_login | 布尔值 | 否 | false | 是否自动登录 |
| language | 字符串 | 否 | zh_CN | 界面语言 |
| theme | 字符串 | 否 | light | 界面主题 |

## 示例配置

```json
{
  "server": "openp2p.example.com",
  "port": 27183,
  "name": "Office",
  "token": "your_token_here",
  "bind": "0.0.0.0",
  "p2p_port": 0,
  "log_level": 2,
  "auto_start": false,
  "auto_login": false,
  "language": "zh_CN",
  "theme": "light"
}
```

## 配置项详细说明

### server

服务器地址，必须填写，不要包含`http://`或`https://`前缀。例如：`openp2p.example.com`或`192.168.1.100`。

### port

服务器端口，默认为27183。如果服务器使用了不同的端口，需要在此处指定。

### name

节点名称，用于在管理界面中显示。如果不指定，将使用系统主机名。建议使用有意义的名称，例如"办公室"、"家里"等。

### token

节点令牌，必须填写。在管理界面创建节点时获取，用于验证节点身份。令牌是一串随机字符，例如：`a1b2c3d4e5f6g7h8`。

### bind

绑定地址，默认为`0.0.0.0`，表示监听所有网络接口。如果需要限制只监听特定网络接口，可以指定IP地址。

### p2p_port

P2P端口，默认为0，表示随机选择一个可用端口。如果需要指定固定端口，可以在此处设置。

### log_level

日志级别，控制日志输出的详细程度：
- 0：关闭日志
- 1：只记录错误信息
- 2：记录信息和错误（默认）
- 3：记录调试、信息和错误

### auto_start

是否自动启动，默认为false。如果设置为true，客户端将在启动后自动连接服务器。

### auto_login

是否自动登录，默认为false。如果设置为true，客户端将在启动后自动尝试登录。

### language

界面语言，默认为`zh_CN`（简体中文）。目前支持的语言：
- `zh_CN`：简体中文
- `en_US`：英文

### theme

界面主题，默认为`light`（亮色主题）。目前支持的主题：
- `light`：亮色主题
- `dark`：暗色主题

## 配置文件位置

客户端会按以下顺序查找配置文件：

1. 命令行参数`-config`指定的路径
2. 当前工作目录中的`config.json`
3. 客户端可执行文件所在目录中的`config.json`

如果找不到配置文件，客户端将在可执行文件所在目录创建一个示例配置文件`config.json`，并提示用户编辑后重新启动。

## 日志文件位置

客户端日志默认保存在以下位置：

- Windows: `%LOCALAPPDATA%\OpenP2P\logs\`
- Linux: `~/.local/share/openp2p/logs/`
- macOS: `~/Library/Application Support/OpenP2P/logs/`

如果无法在上述位置创建日志文件，客户端会尝试在当前目录下创建`logs`文件夹并保存日志。如果仍然失败，将使用系统临时目录。

日志文件名格式为`client_YYYYMMDD.log`，例如`client_20230401.log`。

## 注意事项

1. **服务器地址格式**：服务器地址不应包含协议前缀（如`http://`或`https://`）
2. **节点令牌**：必须与管理界面中创建的节点令牌一致
3. **日志级别**：生产环境建议使用级别2（信息），调试问题时可设为3（调试）
4. **用户名和密码字段**：旧版本中的`username`和`password`字段已不再使用，请使用`token`字段进行身份验证

## 命令行参数

客户端支持以下命令行参数：

```
-config string   配置文件路径 (默认 "config.json")
```

示例：

```bash
./openp2p-client -config=/path/to/config.json
```

## 配置更新

修改配置文件后，需要重启客户端才能使新配置生效。

## 客户端启动与连接

启动客户端后，您可能会看到类似以下的日志：

```
2025/03/17 09:18:08 Running in development mode
2025/03/17 09:18:08 Starting HTTP server on port 27183 in production mode
```

这表明客户端已经启动，但没有显示与服务器的连接状态。要查看更详细的连接日志，您可以：

1. 将`log_level`设置为`3`（调试级别）
2. 查看客户端日志文件，通常位于：
   - Windows: `%LOCALAPPDATA%\OpenP2P\logs\`
   - Linux: `~/.local/share/openp2p/logs/`
   - macOS: `~/Library/Application Support/OpenP2P/logs/`

## 功能说明

### P2P隧道与网络分段

1. **原始OpenP2P项目**：使用P2P隧道打洞，设备之间进行组网，并分配独立网段。

2. **当前版本**：
   - 保留了P2P隧道打洞功能，允许不同网络环境下的设备直接通信
   - 简化了网络分段配置，不再要求用户手动配置网段
   - 增强了NAT穿透能力，支持更多复杂网络环境
   - 添加了中继服务器功能，当P2P连接失败时自动切换到中继模式

3. **网络分段**：在当前版本中，网络分段是可选的。如果您需要创建虚拟局域网，可以在高级设置中启用此功能。对于大多数端口映射和远程访问场景，不需要配置网络分段。

## 故障排除

如果客户端无法连接到服务器，请检查：

1. 服务器地址和端口是否正确
2. Token是否与服务器上注册的节点匹配
3. 防火墙是否允许客户端访问服务器
4. 网络连接是否稳定

如需更多帮助，请查看日志文件或联系管理员。 